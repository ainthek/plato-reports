<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/sntp/test/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/sntp/test/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">75.77</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">432</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">48.00</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">5.01</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Load modules

var Dns = require(&#039;dns&#039;);
var Dgram = require(&#039;dgram&#039;);
var Lab = require(&#039;lab&#039;);
var Sntp = require(&#039;../lib&#039;);


// Declare internals

var internals = {};


// Test shortcuts

var lab = exports.lab = Lab.script();
var before = lab.before;
var after = lab.after;
var describe = lab.experiment;
var it = lab.test;
var expect = Lab.expect;


describe(&#039;SNTP&#039;, function () {

    describe(&#039;#time&#039;, function () {

        it(&#039;returns consistent result over multiple tries&#039;, function (done) {

            Sntp.time(function (err, time) {

                expect(err).to.not.exist;
                expect(time).to.exist;
                var t1 = time.t;

                Sntp.time(function (err, time) {

                    expect(err).to.not.exist;
                    expect(time).to.exist;
                    var t2 = time.t;
                    expect(Math.abs(t1 - t2)).is.below(200);
                    done();
                });
            });
        });

        it(&#039;resolves reference IP&#039;, function (done) {

            Sntp.time({ host: &#039;ntp.exnet.com&#039;, resolveReference: true }, function (err, time) {

                expect(err).to.not.exist;
                expect(time).to.exist;
                expect(time.referenceHost).to.exist;
                done();
            });
        });

        it(&#039;times out on no response&#039;, function (done) {

            Sntp.time({ port: 124, timeout: 100 }, function (err, time) {

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(&#039;Timeout&#039;);
                done();
            });
        });

        it(&#039;errors on error event&#039;, { parallel: false }, function (done) {

            var orig = Dgram.createSocket;
            Dgram.createSocket = function (type) {

                Dgram.createSocket = orig;
                var socket = Dgram.createSocket(type);
                setImmediate(function () { socket.emit(&#039;error&#039;, new Error(&#039;Fake&#039;)) });
                return socket;
            };

            Sntp.time(function (err, time) {

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(&#039;Fake&#039;);
                done();
            });
        });

        it(&#039;errors on incorrect sent size&#039;, { parallel: false }, function (done) {

            var orig = Dgram.Socket.prototype.send;
            Dgram.Socket.prototype.send = function (buf, offset, length, port, address, callback) {

                Dgram.Socket.prototype.send = orig;
                return callback(null, 40);
            };

            Sntp.time(function (err, time) {

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.equal(&#039;Could not send entire message&#039;);
                done();
            });
        });

        it(&#039;times out on invalid host&#039;, function (done) {

            Sntp.time({ host: &#039;error&#039;, timeout: 10000 }, function (err, time) {

                expect(err).to.exist;
                expect(time).to.not.exist;
                expect(err.message).to.contain(&#039;getaddrinfo&#039;);
                done();
            });
        });

        it(&#039;fails on bad response buffer size&#039;, function (done) {

            var server = Dgram.createSocket(&#039;udp4&#039;);
            server.on(&#039;message&#039;, function (message, remote) {
                var message = new Buffer(10);
                server.send(message, 0, message.length, remote.port, remote.address, function (err, bytes) {

                    server.close();
                });
            });

            server.bind(49123);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Invalid server response&#039;);
                done();
            });
        });

        var messup = function (bytes) {

            var server = Dgram.createSocket(&#039;udp4&#039;);
            server.on(&#039;message&#039;, function (message, remote) {

                var message = new Buffer([
                    0x24, 0x01, 0x00, 0xe3,
                    0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00,
                    0x41, 0x43, 0x54, 0x53,
                    0xd4, 0xa8, 0x2d, 0xc7,
                    0x1c, 0x5d, 0x49, 0x1b,
                    0xd4, 0xa8, 0x2d, 0xe6,
                    0x67, 0xef, 0x9d, 0xb2,
                    0xd4, 0xa8, 0x2d, 0xe6,
                    0x71, 0xed, 0xb5, 0xfb,
                    0xd4, 0xa8, 0x2d, 0xe6,
                    0x71, 0xee, 0x6c, 0xc5
                ]);

                for (var i = 0, il = bytes.length; i &lt; il; ++i) {
                    message[bytes[i][0]] = bytes[i][1];
                }

                server.send(message, 0, message.length, remote.port, remote.address, function (err, bytes) {

                    server.close();
                });
            });

            server.bind(49123);
        };

        it(&#039;fails on bad version&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (3 &lt;&lt; 3) + (4 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.version).to.equal(3);
                expect(err.message).to.equal(&#039;Invalid server response&#039;);
                done();
            });
        });

        it(&#039;fails on bad originateTimestamp&#039;, function (done) {

            messup([[24, 0x83], [25, 0xaa], [26, 0x7e], [27, 0x80], [28, 0], [29, 0], [30, 0], [31, 0]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Invalid server response&#039;);
                done();
            });
        });

        it(&#039;fails on bad receiveTimestamp&#039;, function (done) {

            messup([[32, 0x83], [33, 0xaa], [34, 0x7e], [35, 0x80], [36, 0], [37, 0], [38, 0], [39, 0]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Invalid server response&#039;);
                done();
            });
        });

        it(&#039;fails on bad originate timestamp and alarm li&#039;, function (done) {

            messup([[0, (3 &lt;&lt; 6) + (4 &lt;&lt; 3) + (4 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Wrong originate timestamp&#039;);
                expect(time.leapIndicator).to.equal(&#039;alarm&#039;);
                done();
            });
        });

        it(&#039;returns time with death stratum and last61 li&#039;, function (done) {

            messup([[0, (1 &lt;&lt; 6) + (4 &lt;&lt; 3) + (4 &lt;&lt; 0)], [1, 0]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(time.stratum).to.equal(&#039;death&#039;);
                expect(time.leapIndicator).to.equal(&#039;last-minute-61&#039;);
                done();
            });
        });

        it(&#039;returns time with reserved stratum and last59 li&#039;, function (done) {

            messup([[0, (2 &lt;&lt; 6) + (4 &lt;&lt; 3) + (4 &lt;&lt; 0)], [1, 0x1f]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(time.stratum).to.equal(&#039;reserved&#039;);
                expect(time.leapIndicator).to.equal(&#039;last-minute-59&#039;);
                done();
            });
        });

        it(&#039;fails on bad mode (symmetric-active)&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (4 &lt;&lt; 3) + (1 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.mode).to.equal(&#039;symmetric-active&#039;);
                done();
            });
        });

        it(&#039;fails on bad mode (symmetric-passive)&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (4 &lt;&lt; 3) + (2 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.mode).to.equal(&#039;symmetric-passive&#039;);
                done();
            });
        });

        it(&#039;fails on bad mode (client)&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (4 &lt;&lt; 3) + (3 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.mode).to.equal(&#039;client&#039;);
                done();
            });
        });

        it(&#039;fails on bad mode (broadcast)&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (4 &lt;&lt; 3) + (5 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.mode).to.equal(&#039;broadcast&#039;);
                done();
            });
        });

        it(&#039;fails on bad mode (reserved)&#039;, function (done) {

            messup([[0, (0 &lt;&lt; 6) + (4 &lt;&lt; 3) + (6 &lt;&lt; 0)]]);

            Sntp.time({ host: &#039;localhost&#039;, port: 49123 }, function (err, time) {

                expect(err).to.exist;
                expect(time.mode).to.equal(&#039;reserved&#039;);
                done();
            });
        });
    });

    describe(&#039;#offset&#039;, function () {

        it(&#039;gets the current offset&#039;, function (done) {

            Sntp.offset(function (err, offset) {

                expect(err).to.not.exist;
                expect(offset).to.not.equal(0);
                done();
            });
        });

        it(&#039;gets the current offset from cache&#039;, function (done) {

            Sntp.offset(function (err, offset) {

                expect(err).to.not.exist;
                expect(offset).to.not.equal(0);
                var offset1 = offset;
                Sntp.offset({}, function (err, offset) {

                    expect(err).to.not.exist;
                    expect(offset).to.equal(offset1);
                    done();
                });
            });
        });

        it(&#039;gets the new offset on different server&#039;, function (done) {

            Sntp.offset(function (err, offset) {

                expect(err).to.not.exist;
                expect(offset).to.not.equal(0);
                var offset1 = offset;
                Sntp.offset({ host: &#039;nist1-sj.ustiming.org&#039; }, function (err, offset) {

                    expect(err).to.not.exist;
                    expect(offset).to.not.equal(offset1);
                    done();
                });
            });
        });

        it(&#039;gets the new offset on different server&#039;, function (done) {

            Sntp.offset(function (err, offset) {

                expect(err).to.not.exist;
                expect(offset).to.not.equal(0);
                var offset1 = offset;
                Sntp.offset({ port: 123 }, function (err, offset) {

                    expect(err).to.not.exist;
                    expect(offset).to.not.equal(offset1);
                    done();
                });
            });
        });

        it(&#039;fails getting the current offset on invalid server&#039;, function (done) {

            Sntp.offset({ host: &#039;error&#039; }, function (err, offset) {

                expect(err).to.exist;
                expect(offset).to.equal(0);
                done();
            });
        });
    });

    describe(&#039;#now&#039;, function () {

        it(&#039;starts auto-sync, gets now, then stops&#039;, function (done) {

            Sntp.stop();

            var before = Sntp.now();
            expect(before).to.equal(Date.now());

            Sntp.start(function () {

                var now = Sntp.now();
                expect(now).to.not.equal(Date.now());
                Sntp.stop();

                done();
            });
        });

        it(&#039;starts twice&#039;, function (done) {

            Sntp.start(function () {

                Sntp.start(function () {

                    var now = Sntp.now();
                    expect(now).to.not.equal(Date.now());
                    Sntp.stop();

                    done();
                });
            });
        });

        it(&#039;starts auto-sync, gets now, waits, gets again after timeout&#039;, function (done) {

            Sntp.stop();

            var before = Sntp.now();
            expect(before).to.equal(Date.now());

            Sntp.start({ clockSyncRefresh: 100 }, function () {

                var now = Sntp.now();
                expect(now).to.not.equal(Date.now());
                expect(now).to.equal(Sntp.now());

                setTimeout(function () {

                    expect(Sntp.now()).to.not.equal(now);
                    Sntp.stop();
                    done();
                }, 110);
            });
        });
    });
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
