<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/selenium-webdriver/lib/webdriver/testing/flowtester.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/selenium-webdriver/lib/webdriver/testing/flowtester.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">73.87</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">358</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">54.62</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.19</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Copyright 2013 Software Freedom Conservancy. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

goog.provide(&#039;webdriver.testing.Clock&#039;);
goog.provide(&#039;webdriver.testing.promise.FlowTester&#039;);

goog.require(&#039;goog.array&#039;);
goog.require(&#039;webdriver.promise.ControlFlow&#039;);



/**
 * Describes an object that can be used to advance the clock and trigger
 * timeouts registered on the global timing functions.
 * @interface
 */
webdriver.testing.Clock = function() {};


/**
 * Advances the clock.
 * @param {number=} opt_ms The number of milliseconds to advance the clock by.
 *     Defaults to 1 ms.
 */
webdriver.testing.Clock.prototype.tick = function(opt_ms) {};



/**
 * Utility for writing unit tests against a
 * {@link webdriver.promise.ControlFlow}. This class assumes the global
 * timeout functions (e.g. setTimeout) have been replaced with test doubles.
 * These doubles should allow registered timeouts to be triggered by
 * calling {@code clock.tick()}.
 * @param {!webdriver.testing.Clock} clock The fake clock to use.
 * @param {{clearInterval: function(number),
 *          clearTimeout: function(number),
 *          setInterval: function(!Function, number): number,
 *          setTimeout: function(!Function, number): number}} timer
 *     The timer object to use for the application under test.
 * @constructor
 * @implements {goog.disposable.IDisposable}
 */
webdriver.testing.promise.FlowTester = function(clock, timer) {

  var self = this;

  /** @private {!webdriver.testing.Clock} */
  this.clock_ = clock;

  /**
   * @private {!Array.&lt;{isIdle: boolean,
   *                    errors: !Array.&lt;!Error&gt;,
   *                    flow: !webdriver.promise.ControlFlow}&gt;}
   */
  this.allFlows_ = [];

  /** @private {!webdriver.promise.ControlFlow} */
  this.flow_ = createFlow();

  /** @private {!webdriver.promise.ControlFlow} */
  this.originalFlow_ = webdriver.promise.controlFlow();
  webdriver.promise.setDefaultFlow(this.flow_);

  /**
   * @private {function(function(!webdriver.promise.ControlFlow)):
   *               !webdriver.promise.Promise}
   */
  this.originalCreateFlow_ = webdriver.promise.createFlow;

  /**
   * @param {function(!webdriver.promise.ControlFlow)} callback The entry point
   *     to the newly created flow.
   * @return {!webdriver.promise.Promise} .
   */
  webdriver.promise.createFlow = function(callback) {
    var flow = createFlow();
    return flow.execute(function() {
      return callback(flow);
    });
  };

  function createFlow() {
    var record = {
      isIdle: true,
      errors: [],
      flow: new webdriver.promise.ControlFlow(timer).
          on(webdriver.promise.ControlFlow.EventType.IDLE, function() {
            record.isIdle = true;
          }).
          on(webdriver.promise.ControlFlow.EventType.SCHEDULE_TASK, function() {
            record.isIdle = false;
          }).
          on(webdriver.promise.ControlFlow.EventType.UNCAUGHT_EXCEPTION,
             function(e) {
               record.isIdle = true;
               record.errors.push(e);
             })
    };
    self.allFlows_.push(record);
    return record.flow;
  }
};


/** @private {boolean} */
webdriver.testing.promise.FlowTester.prototype.isDisposed_ = false;


/** @override */
webdriver.testing.promise.FlowTester.prototype.isDisposed = function() {
  return this.isDisposed_;
};


/**
 * Disposes of this instance, restoring the default control flow object.
 * @override
 */
webdriver.testing.promise.FlowTester.prototype.dispose = function() {
  if (!this.isDisposed_) {
    goog.array.forEach(this.allFlows_, function(record) {
      record.flow.reset();
    });
    webdriver.promise.setDefaultFlow(this.originalFlow_);
    webdriver.promise.createFlow = this.originalCreateFlow_;
    this.isDisposed_ = true;
  }
};


/**
 * @param {!Array} messages The array to join into a single error message.
 * @throws {Error} An error with a message formatted from {@code messages}.
 * @private
 */
webdriver.testing.promise.FlowTester.prototype.throwWithMessages_ = function(
    messages) {
  throw Error(messages.join(&#039;\n--------\n&#039;) + &#039;\n === done ===&#039;);
};


/**
 * Verifies that all created flows are idle and completed without any errors.
 * If a specific flow object is provided, will only check that flow.
 * @param {webdriver.promise.ControlFlow=} opt_flow The specific flow to check.
 *     If not specified, will verify against all flows.
 */
webdriver.testing.promise.FlowTester.prototype.verifySuccess = function(
    opt_flow) {
  var messages = [];
  var foundFlow = false;

  goog.array.forEach(this.allFlows_, function(record, index) {
    if (!opt_flow || opt_flow === record.flow) {
      foundFlow = true;
      if (record.errors.length) {
        messages = goog.array.concat(
            messages, &#039;Uncaught errors for flow #&#039; + index,
            goog.array.map(record.errors, function(error) {
              if (!error) {
                error = error + &#039;&#039;;
              }
              return error.stack || error.message || String(error);
            }));
      }

      if (!record.isIdle) {
        messages.push(&#039;Flow #&#039; + index + &#039; is not idle&#039;);
      }
    }
  });

  if (opt_flow &amp;&amp; !foundFlow) {
    messages.push(&#039;Specified flow not found!&#039;);
  }

  if (messages.length) {
    this.throwWithMessages_(messages);
  }
};


/**
 * Verifies that all flows are idle and at least one reported a single failure.
 * If a specific flow object is provided, will only check that flow.
 * @param {webdriver.promise.ControlFlow=} opt_flow The flow expected to have
 *     generated the error.
 */
webdriver.testing.promise.FlowTester.prototype.verifyFailure = function(
    opt_flow) {
  var messages = [];
  var foundFlow = false;
  var foundAFailure = false;

  goog.array.forEach(this.allFlows_, function(record, index) {
    if (!opt_flow || opt_flow === record.flow) {
      foundFlow = true;

      if (!record.isIdle) {
        messages.push(&#039;Flow #&#039; + index + &#039; is not idle&#039;);
      }

      if (record.errors.length) {
        foundAFailure = true;

        if (record.errors.length &gt; 1) {
          messages = goog.array.concat(
              messages, &#039;Flow #&#039; + index + &#039; had multiple errors: &#039;,
              record.errors);
        }
      }

    }
  });

  if (opt_flow &amp;&amp; !foundFlow) {
    messages.push(&#039;Specified flow not found!&#039;);
  }

  if (!foundAFailure) {
    messages.push(&#039;No failures found!&#039;);
  }

  if (messages.length) {
    this.throwWithMessages_(messages);
  }
};


/**
 * @param {webdriver.promise.ControlFlow=} opt_flow The specific control flow
 *     to check. If not specified, will implicitly verify there was a single
 *     error across all flows.
 * @return {Error} The error reported by the application.
 * @throws {Error} If the application is not finished, or did not report
 *     exactly one error.
 */
webdriver.testing.promise.FlowTester.prototype.getFailure = function(
    opt_flow) {
  this.verifyFailure(opt_flow);

  var errors = [];
  goog.array.forEach(this.allFlows_, function(record) {
    if (!opt_flow || opt_flow === record.flow) {
      errors = goog.array.concat(errors, record.errors);
    }
  });

  if (errors.length &gt; 1) {
    this.throwWithMessages_(goog.array.concat(
        &#039;There was more than one failure&#039;, errors));
  }

  return errors[0];
};


/**
 * Advances the clock so the {@link webdriver.promise.ControlFlow}&#039;s event
 * loop will run once.
 */
webdriver.testing.promise.FlowTester.prototype.turnEventLoop = function() {
  this.clock_.tick(webdriver.promise.ControlFlow.EVENT_LOOP_FREQUENCY);
};


/**
 * @param {webdriver.promise.ControlFlow=} opt_flow The specific flow to check.
 *     If not specified, will verify all flows are still running.
 * @throws {Error} If the application is not running.
 */
webdriver.testing.promise.FlowTester.prototype.assertStillRunning = function(
    opt_flow) {
  var messages = [];
  var foundFlow = false;

  goog.array.forEach(this.allFlows_, function(record, index) {
    if (!opt_flow || opt_flow === record.flow) {
      foundFlow = true;
      if (record.isIdle) {
        messages.push(&#039;Flow #&#039; + index + &#039; is idle&#039;);
      }

      if (record.errors.length) {
        messages = goog.array.concat(
            messages, &#039;Uncaught errors for flow #&#039; + index, record.errors);
      }
    }
  });

  if (opt_flow &amp;&amp; !foundFlow) {
    messages.push(&#039;Specified flow not found!&#039;);
  }

  if (messages.length) {
    this.throwWithMessages_(messages);
  }
};


/**
 * Runs the application, turning its event loop until it is expected to have
 * shutdown (as indicated by having no more frames, or no frames with pending
 * tasks).
 */
webdriver.testing.promise.FlowTester.prototype.run = function() {
  var flow = this.flow_;
  var self = this;
  var done = false;
  var shouldBeDone = false;

  while (!done) {
    this.turnEventLoop();
    if (shouldBeDone) {
      assertIsDone();
    } else {
      determineIfShouldBeDone();
    }

    // If the event loop generated an unhandled promise, it won&#039;t be reported
    // until one more turn of the JS event loop, so we need to tick the
    // clock once more. This is necessary for our tests to simulate a real
    // JS environment.
    this.clock_.tick();
  }

  function assertIsDone() {
    // Shutdown is done in one extra turn of the event loop.
    self.clock_.tick();
    done = goog.array.every(self.allFlows_, function(record) {
      return record.isIdle;
    });

    if (!done) {
      goog.array.forEach(self.allFlows_, function(record) {
        if (record.flow.activeFrame_) {
          // Not done yet, but there are no frames left.  This can happen if the
          // very first scheduled task was scheduled inside of a promise
          // callback. Turn the event loop one more time; the flow should detect
          // that it is now finished and start the shutdown procedure.  Don&#039;t
          // recurse here since we could go into an infinite loop if the flow is
          // broken.
          self.turnEventLoop();
          self.clock_.tick();
        }
      });
    }

    if (!done) {
      throw Error(&#039;Should be done now: &#039; + flow.getSchedule());
    }
  }

  function determineIfShouldBeDone() {
    shouldBeDone = flow === webdriver.promise.controlFlow() &amp;&amp;
        goog.array.every(self.allFlows_, function(record) {
          return !record.flow.activeFrame_;
        });
  }
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
