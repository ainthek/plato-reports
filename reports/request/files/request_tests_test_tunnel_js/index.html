<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - request/tests/test-tunnel.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>request/tests/test-tunnel.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">79.64</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">473</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">38.83</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.38</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">&#039;use strict&#039;

var server = require(&#039;./server&#039;)
  , tape = require(&#039;tape&#039;)
  , request = require(&#039;../index&#039;)
  , https = require(&#039;https&#039;)
  , net = require(&#039;net&#039;)
  , fs = require(&#039;fs&#039;)
  , path = require(&#039;path&#039;)
  , util = require(&#039;util&#039;)
  , url = require(&#039;url&#039;)
  , destroyable = require(&#039;server-destroy&#039;)

var events = []
  , caFile = path.resolve(__dirname, &#039;ssl/ca/ca.crt&#039;)
  , ca = fs.readFileSync(caFile)
  , clientCert = fs.readFileSync(path.resolve(__dirname, &#039;ssl/ca/client.crt&#039;))
  , clientKey = fs.readFileSync(path.resolve(__dirname, &#039;ssl/ca/client-enc.key&#039;))
  , clientPassword = &#039;password&#039;
  , sslOpts = {
    key  : path.resolve(__dirname, &#039;ssl/ca/localhost.key&#039;),
    cert : path.resolve(__dirname, &#039;ssl/ca/localhost.crt&#039;)
  }
  , mutualSSLOpts = {
    key  : path.resolve(__dirname, &#039;ssl/ca/localhost.key&#039;),
    cert : path.resolve(__dirname, &#039;ssl/ca/localhost.crt&#039;),
    ca   : caFile,
    requestCert        : true,
    rejectUnauthorized : true
  }

// this is needed for &#039;https over http, tunnel=false&#039; test
// from https://github.com/coolaj86/node-ssl-root-cas/blob/v1.1.9-beta/ssl-root-cas.js#L4267-L4281
var httpsOpts = https.globalAgent.options
httpsOpts.ca = httpsOpts.ca || []
httpsOpts.ca.push(ca)

var s = server.createServer()
  , ss = server.createSSLServer(null, sslOpts)
  , ss2 = server.createSSLServer(ss.port + 1, mutualSSLOpts)

// XXX when tunneling https over https, connections get left open so the server
// doesn&#039;t want to close normally (and same issue with http server on v0.8.x)
destroyable(s)
destroyable(ss)
destroyable(ss2)

function event() {
  events.push(util.format.apply(null, arguments))
}

function setListeners(server, type) {
  server.on(&#039;/&#039;, function(req, res) {
    event(&#039;%s response&#039;, type)
    res.end(type + &#039; ok&#039;)
  })

  server.on(&#039;request&#039;, function(req, res) {
    if (/^https?:/.test(req.url)) {
      // This is a proxy request
      var dest = req.url.split(&#039;:&#039;)[0]
      // Is it a redirect?
      var match = req.url.match(/\/redirect\/(https?)$/)
      if (match) {
        dest += &#039;-&gt;&#039; + match[1]
      }
      event(&#039;%s proxy to %s&#039;, type, dest)
      request(req.url, { followRedirect : false }).pipe(res)
    }
  })

  server.on(&#039;/redirect/http&#039;, function(req, res) {
    event(&#039;%s redirect to http&#039;, type)
    res.writeHead(301, {
      location : s.url
    })
    res.end()
  })

  server.on(&#039;/redirect/https&#039;, function(req, res) {
    event(&#039;%s redirect to https&#039;, type)
    res.writeHead(301, {
      location : ss.url
    })
    res.end()
  })

  server.on(&#039;connect&#039;, function(req, client, head) {
    var u = url.parse(req.url)
    var server = net.connect(u.host, u.port, function() {
      event(&#039;%s connect to %s&#039;, type, req.url)
      client.write(&#039;HTTP/1.1 200 Connection established\r\n\r\n&#039;)
      client.pipe(server)
      server.write(head)
      server.pipe(client)
    })
  })
}

setListeners(s, &#039;http&#039;)
setListeners(ss, &#039;https&#039;)
setListeners(ss2, &#039;https&#039;)

tape(&#039;setup&#039;, function(t) {
  s.listen(s.port, function() {
    ss.listen(ss.port, function() {
      ss2.listen(ss2.port, &#039;localhost&#039;, function() {
        t.end()
      })
    })
  })
})

// monkey-patch since you can&#039;t set a custom certificate authority for the
// proxy in tunnel-agent (this is necessary for &quot;* over https&quot; tests)
var customCaCount = 0
var httpsRequestOld = https.request
https.request = function(options) {
  if (customCaCount) {
    options.ca = ca
    customCaCount--
  }
  return httpsRequestOld.apply(this, arguments)
}

function runTest(name, opts, expected) {
  tape(name, function(t) {
    opts.ca = ca
    if (opts.proxy === ss.url) {
      customCaCount = (opts.url === ss.url ? 2 : 1)
    }
    request(opts, function(err, res, body) {
      event(err ? &#039;err &#039; + err.message : res.statusCode + &#039; &#039; + body)
      t.deepEqual(events, expected)
      events = []
      t.end()
    })
  })
}


// HTTP OVER HTTP

runTest(&#039;http over http, tunnel=true&#039;, {
  url    : s.url,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http over http, tunnel=false&#039;, {
  url    : s.url,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http over http, tunnel=default&#039;, {
  url    : s.url,
  proxy  : s.url
}, [
  &#039;http proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])


// HTTP OVER HTTPS

runTest(&#039;http over https, tunnel=true&#039;, {
  url    : s.url,
  proxy  : ss.url,
  tunnel : true
}, [
  &#039;https connect to localhost:&#039; + s.port,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http over https, tunnel=false&#039;, {
  url    : s.url,
  proxy  : ss.url,
  tunnel : false
}, [
  &#039;https proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http over https, tunnel=default&#039;, {
  url    : s.url,
  proxy  : ss.url
}, [
  &#039;https proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])


// HTTPS OVER HTTP

runTest(&#039;https over http, tunnel=true&#039;, {
  url    : ss.url,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https over http, tunnel=false&#039;, {
  url    : ss.url,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to https&#039;,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https over http, tunnel=default&#039;, {
  url    : ss.url,
  proxy  : s.url
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])


// HTTPS OVER HTTPS

runTest(&#039;https over https, tunnel=true&#039;, {
  url    : ss.url,
  proxy  : ss.url,
  tunnel : true
}, [
  &#039;https connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https over https, tunnel=false&#039;, {
  url    : ss.url,
  proxy  : ss.url,
  tunnel : false,
  pool   : false // must disable pooling here or Node.js hangs
}, [
  &#039;https proxy to https&#039;,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https over https, tunnel=default&#039;, {
  url    : ss.url,
  proxy  : ss.url
}, [
  &#039;https connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])


// HTTP-&gt;HTTP OVER HTTP

runTest(&#039;http-&gt;http over http, tunnel=true&#039;, {
  url    : s.url + &#039;/redirect/http&#039;,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http redirect to http&#039;,
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http-&gt;http over http, tunnel=false&#039;, {
  url    : s.url + &#039;/redirect/http&#039;,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to http-&gt;http&#039;,
  &#039;http redirect to http&#039;,
  &#039;http proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;http-&gt;http over http, tunnel=default&#039;, {
  url    : s.url + &#039;/redirect/http&#039;,
  proxy  : s.url
}, [
  &#039;http proxy to http-&gt;http&#039;,
  &#039;http redirect to http&#039;,
  &#039;http proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])


// HTTP-&gt;HTTPS OVER HTTP

runTest(&#039;http-&gt;https over http, tunnel=true&#039;, {
  url    : s.url + &#039;/redirect/https&#039;,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http redirect to https&#039;,
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;http-&gt;https over http, tunnel=false&#039;, {
  url    : s.url + &#039;/redirect/https&#039;,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to http-&gt;https&#039;,
  &#039;http redirect to https&#039;,
  &#039;http proxy to https&#039;,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;http-&gt;https over http, tunnel=default&#039;, {
  url    : s.url + &#039;/redirect/https&#039;,
  proxy  : s.url
}, [
  &#039;http proxy to http-&gt;https&#039;,
  &#039;http redirect to https&#039;,
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])


// HTTPS-&gt;HTTP OVER HTTP

runTest(&#039;https-&gt;http over http, tunnel=true&#039;, {
  url    : ss.url + &#039;/redirect/http&#039;,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https redirect to http&#039;,
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;https-&gt;http over http, tunnel=false&#039;, {
  url    : ss.url + &#039;/redirect/http&#039;,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to https-&gt;http&#039;,
  &#039;https redirect to http&#039;,
  &#039;http proxy to http&#039;,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])

runTest(&#039;https-&gt;http over http, tunnel=default&#039;, {
  url    : ss.url + &#039;/redirect/http&#039;,
  proxy  : s.url
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https redirect to http&#039;,
  &#039;http connect to localhost:&#039; + s.port,
  &#039;http response&#039;,
  &#039;200 http ok&#039;
])


// HTTPS-&gt;HTTPS OVER HTTP

runTest(&#039;https-&gt;https over http, tunnel=true&#039;, {
  url    : ss.url + &#039;/redirect/https&#039;,
  proxy  : s.url,
  tunnel : true
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https redirect to https&#039;,
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https-&gt;https over http, tunnel=false&#039;, {
  url    : ss.url + &#039;/redirect/https&#039;,
  proxy  : s.url,
  tunnel : false
}, [
  &#039;http proxy to https-&gt;https&#039;,
  &#039;https redirect to https&#039;,
  &#039;http proxy to https&#039;,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

runTest(&#039;https-&gt;https over http, tunnel=default&#039;, {
  url    : ss.url + &#039;/redirect/https&#039;,
  proxy  : s.url
}, [
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https redirect to https&#039;,
  &#039;http connect to localhost:&#039; + ss.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])


// MUTUAL HTTPS OVER HTTP

runTest(&#039;mutual https over http, tunnel=true&#039;, {
  url        : ss2.url,
  proxy      : s.url,
  tunnel     : true,
  cert       : clientCert,
  key        : clientKey,
  passphrase : clientPassword
}, [
  &#039;http connect to localhost:&#039; + ss2.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])

// XXX causes &#039;Error: socket hang up&#039;
// runTest(&#039;mutual https over http, tunnel=false&#039;, {
//   url        : ss2.url,
//   proxy      : s.url,
//   tunnel     : false,
//   cert       : clientCert,
//   key        : clientKey,
//   passphrase : clientPassword
// }, [
//   &#039;http connect to localhost:&#039; + ss2.port,
//   &#039;https response&#039;,
//   &#039;200 https ok&#039;
// ])

runTest(&#039;mutual https over http, tunnel=default&#039;, {
  url        : ss2.url,
  proxy      : s.url,
  cert       : clientCert,
  key        : clientKey,
  passphrase : clientPassword
}, [
  &#039;http connect to localhost:&#039; + ss2.port,
  &#039;https response&#039;,
  &#039;200 https ok&#039;
])


tape(&#039;cleanup&#039;, function(t) {
  s.destroy(function() {
    ss.destroy(function() {
      ss2.destroy(function() {
        t.end()
      })
    })
  })
})</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
