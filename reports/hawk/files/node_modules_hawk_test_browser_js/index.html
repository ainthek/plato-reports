<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/hawk/test/browser.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/hawk/test/browser.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">68.98</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">1450</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">125.38</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">18.43</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Load modules

var Url = require(&#039;url&#039;);
var Lab = require(&#039;lab&#039;);
var Hoek = require(&#039;hoek&#039;);
var Hawk = require(&#039;../lib&#039;);
var Browser = require(&#039;../lib/browser&#039;);


// Declare internals

var internals = {};


// Test shortcuts

var lab = exports.lab = Lab.script();
var describe = lab.experiment;
var it = lab.test;
var expect = Lab.expect;


describe(&#039;Browser&#039;, function () {

    var credentialsFunc = function (id, callback) {

        var credentials = {
            id: id,
            key: &#039;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#039;,
            algorithm: (id === &#039;1&#039; ? &#039;sha1&#039; : &#039;sha256&#039;),
            user: &#039;steve&#039;
        };

        return callback(null, credentials);
    };

    it(&#039;should generate a bewit then successfully authenticate it&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?a=1&amp;b=2&#039;,
            host: &#039;example.com&#039;,
            port: 80
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var bewit = Browser.client.bewit(&#039;http://example.com/resource/4?a=1&amp;b=2&#039;, { credentials: credentials, ttlSec: 60 * 60 * 24 * 365 * 100, ext: &#039;some-app-data&#039; });
            req.url += &#039;&amp;bewit=&#039; + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, function (err, credentials, attributes) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(attributes.ext).to.equal(&#039;some-app-data&#039;);
                done();
            });
        });
    });

    it(&#039;should generate a bewit then successfully authenticate it (no ext)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?a=1&amp;b=2&#039;,
            host: &#039;example.com&#039;,
            port: 80
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var bewit = Browser.client.bewit(&#039;http://example.com/resource/4?a=1&amp;b=2&#039;, { credentials: credentials, ttlSec: 60 * 60 * 24 * 365 * 100 });
            req.url += &#039;&amp;bewit=&#039; + bewit;

            Hawk.uri.authenticate(req, credentialsFunc, {}, function (err, credentials, attributes) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                done();
            });
        });
    });

    describe(&#039;#bewit&#039;, function () {

        it(&#039;returns a valid bewit value&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6&#039;);
            done();
        });

        it(&#039;returns a valid bewit value (explicit HTTP port)&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;http://example.com:8080/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;MTIzNDU2XDEzNTY0MjA3MDdcaFpiSjNQMmNLRW80a3kwQzhqa1pBa1J5Q1p1ZWc0V1NOYnhWN3ZxM3hIVT1ceGFuZHlhbmR6&#039;);
            done();
        });

        it(&#039;returns a valid bewit value (explicit HTTPS port)&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com:8043/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;MTIzNDU2XDEzNTY0MjA3MDdcL2t4UjhwK0xSaTdvQTRnUXc3cWlxa3BiVHRKYkR4OEtRMC9HRUwvVytTUT1ceGFuZHlhbmR6&#039;);
            done();
        });

        it(&#039;returns a valid bewit value (null ext)&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: null });
            expect(bewit).to.equal(&#039;MTIzNDU2XDEzNTY0MjA3MDdcSUdZbUxnSXFMckNlOEN4dktQczRKbFdJQStValdKSm91d2dBUmlWaENBZz1c&#039;);
            done();
        });

        it(&#039;errors on invalid options&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, 4);
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on missing uri&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;&#039;, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on invalid uri&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(5, { credentials: credentials, ttlSec: 300, localtimeOffsetMsec: 1356420407232 - Hawk.utils.now(), ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on invalid credentials (id)&#039;, function (done) {

            var credentials = {
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 3000, ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on missing credentials&#039;, function (done) {

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { ttlSec: 3000, ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on invalid credentials (key)&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                algorithm: &#039;sha256&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 3000, ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on invalid algorithm&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;hmac-sha-0&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;, { credentials: credentials, ttlSec: 300, ext: &#039;xandyandz&#039; });
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });

        it(&#039;errors on missing options&#039;, function (done) {

            var credentials = {
                id: &#039;123456&#039;,
                key: &#039;2983d45yun89q&#039;,
                algorithm: &#039;hmac-sha-0&#039;
            };

            var bewit = Browser.client.bewit(&#039;https://example.com/somewhere/over/the/rainbow&#039;);
            expect(bewit).to.equal(&#039;&#039;);
            done();
        });
    });

    it(&#039;generates a header then successfully parse it (configuration)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; }).field;
            expect(req.authorization).to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (node request)&#039;, function (done) {

        var req = {
            method: &#039;POST&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            headers: {
                host: &#039;example.com:8080&#039;,
                &#039;content-type&#039;: &#039;text/plain;x=y&#039;
            }
        };

        var payload = &#039;some not so random text&#039;;

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var reqHeader = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, payload: payload, contentType: req.headers[&#039;content-type&#039;] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers[&#039;content-type&#039;])).to.equal(true);

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                res.headers[&#039;server-authorization&#039;] = Hawk.server.header(credentials, artifacts, { payload: &#039;some reply&#039;, contentType: &#039;text/plain&#039;, ext: &#039;response-specific&#039; });
                expect(res.headers[&#039;server-authorization&#039;]).to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts, { payload: &#039;some reply&#039; })).to.equal(true);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (browserify)&#039;, function (done) {

        var req = {
            method: &#039;POST&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            headers: {
                host: &#039;example.com:8080&#039;,
                &#039;content-type&#039;: &#039;text/plain;x=y&#039;
            }
        };

        var payload = &#039;some not so random text&#039;;

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var reqHeader = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, payload: payload, contentType: req.headers[&#039;content-type&#039;] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers[&#039;content-type&#039;])).to.equal(true);

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;
                    },
                    getHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                res.headers[&#039;server-authorization&#039;] = Hawk.server.header(credentials, artifacts, { payload: &#039;some reply&#039;, contentType: &#039;text/plain&#039;, ext: &#039;response-specific&#039; });
                expect(res.headers[&#039;server-authorization&#039;]).to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts, { payload: &#039;some reply&#039; })).to.equal(true);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (time offset)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, localtimeOffsetMsec: 100000 }).field;
            expect(req.authorization).to.exist;

            Hawk.server.authenticate(req, credentialsFunc, { localtimeOffsetMsec: 100000 }, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (no server header options)&#039;, function (done) {

        var req = {
            method: &#039;POST&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            headers: {
                host: &#039;example.com:8080&#039;,
                &#039;content-type&#039;: &#039;text/plain;x=y&#039;
            }
        };

        var payload = &#039;some not so random text&#039;;

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var reqHeader = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, payload: payload, contentType: req.headers[&#039;content-type&#039;] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers[&#039;content-type&#039;])).to.equal(true);

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                res.headers[&#039;server-authorization&#039;] = Hawk.server.header(credentials, artifacts);
                expect(res.headers[&#039;server-authorization&#039;]).to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(true);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (no server header)&#039;, function (done) {

        var req = {
            method: &#039;POST&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            headers: {
                host: &#039;example.com:8080&#039;,
                &#039;content-type&#039;: &#039;text/plain;x=y&#039;
            }
        };

        var payload = &#039;some not so random text&#039;;

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var reqHeader = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, payload: payload, contentType: req.headers[&#039;content-type&#039;] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers[&#039;content-type&#039;])).to.equal(true);

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(true);
                done();
            });
        });
    });

    it(&#039;generates a header with stale ts and successfully authenticate on second call&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            Browser.utils.setNtpOffset(60 * 60 * 1000);
            var header = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; });
            req.authorization = header.field;
            expect(req.authorization).to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Stale timestamp&#039;);

                var res = {
                    headers: {
                        &#039;www-authenticate&#039;: err.output.headers[&#039;WWW-Authenticate&#039;]
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.utils.getNtpOffset()).to.equal(60 * 60 * 1000);
                expect(Browser.client.authenticate(res, credentials, header.artifacts)).to.equal(true);
                expect(Browser.utils.getNtpOffset()).to.equal(0);

                req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; }).field;
                expect(req.authorization).to.exist;

                Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                    expect(err).to.not.exist;
                    expect(credentials.user).to.equal(&#039;steve&#039;);
                    expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                    done();
                });
            });
        });
    });

    it(&#039;generates a header with stale ts and successfully authenticate on second call (manual localStorage)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var localStorage = new Browser.internals.LocalStorage();

            Browser.utils.setStorage(localStorage)

            Browser.utils.setNtpOffset(60 * 60 * 1000);
            var header = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; });
            req.authorization = header.field;
            expect(req.authorization).to.exist;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.exist;
                expect(err.message).to.equal(&#039;Stale timestamp&#039;);

                var res = {
                    headers: {
                        &#039;www-authenticate&#039;: err.output.headers[&#039;WWW-Authenticate&#039;]
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(parseInt(localStorage.getItem(&#039;hawk_ntp_offset&#039;))).to.equal(60 * 60 * 1000);
                expect(Browser.utils.getNtpOffset()).to.equal(60 * 60 * 1000);
                expect(Browser.client.authenticate(res, credentials, header.artifacts)).to.equal(true);
                expect(Browser.utils.getNtpOffset()).to.equal(0);
                expect(parseInt(localStorage.getItem(&#039;hawk_ntp_offset&#039;))).to.equal(0);

                req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; }).field;
                expect(req.authorization).to.exist;

                Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                    expect(err).to.not.exist;
                    expect(credentials.user).to.equal(&#039;steve&#039;);
                    expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                    done();
                });
            });
        });
    });

    it(&#039;generates a header then fails to parse it (missing server header hash)&#039;, function (done) {

        var req = {
            method: &#039;POST&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            headers: {
                host: &#039;example.com:8080&#039;,
                &#039;content-type&#039;: &#039;text/plain;x=y&#039;
            }
        };

        var payload = &#039;some not so random text&#039;;

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            var reqHeader = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, payload: payload, contentType: req.headers[&#039;content-type&#039;] });
            req.headers.authorization = reqHeader.field;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(payload, credentials, artifacts, req.headers[&#039;content-type&#039;])).to.equal(true);

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                res.headers[&#039;server-authorization&#039;] = Hawk.server.header(credentials, artifacts);
                expect(res.headers[&#039;server-authorization&#039;]).to.exist;

                expect(Browser.client.authenticate(res, credentials, artifacts, { payload: &#039;some reply&#039; })).to.equal(false);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (with hash)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, payload: &#039;hola!&#039;, ext: &#039;some-app-data&#039; }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it then validate payload&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, payload: &#039;hola!&#039;, ext: &#039;some-app-data&#039; }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(Hawk.server.authenticatePayload(&#039;hola!&#039;, credentials, artifacts)).to.be.true;
                expect(Hawk.server.authenticatePayload(&#039;hello!&#039;, credentials, artifacts)).to.be.false;
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (app)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, app: &#039;asd23ased&#039; }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(artifacts.app).to.equal(&#039;asd23ased&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header then successfully parse it (app, dlg)&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039;, app: &#039;asd23ased&#039;, dlg: &#039;23434szr3q4d&#039; }).field;
            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.not.exist;
                expect(credentials.user).to.equal(&#039;steve&#039;);
                expect(artifacts.ext).to.equal(&#039;some-app-data&#039;);
                expect(artifacts.app).to.equal(&#039;asd23ased&#039;);
                expect(artifacts.dlg).to.equal(&#039;23434szr3q4d&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header then fail authentication due to bad hash&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, payload: &#039;hola!&#039;, ext: &#039;some-app-data&#039; }).field;
            Hawk.server.authenticate(req, credentialsFunc, { payload: &#039;byebye!&#039; }, function (err, credentials, artifacts) {

                expect(err).to.exist;
                expect(err.output.payload.message).to.equal(&#039;Bad payload hash&#039;);
                done();
            });
        });
    });

    it(&#039;generates a header for one resource then fail to authenticate another&#039;, function (done) {

        var req = {
            method: &#039;GET&#039;,
            url: &#039;/resource/4?filter=a&#039;,
            host: &#039;example.com&#039;,
            port: 8080
        };

        credentialsFunc(&#039;123456&#039;, function (err, credentials) {

            req.authorization = Browser.client.header(&#039;http://example.com:8080/resource/4?filter=a&#039;, req.method, { credentials: credentials, ext: &#039;some-app-data&#039; }).field;
            req.url = &#039;/something/else&#039;;

            Hawk.server.authenticate(req, credentialsFunc, {}, function (err, credentials, artifacts) {

                expect(err).to.exist;
                expect(credentials).to.exist;
                done();
            });
        });
    });

    describe(&#039;client&#039;, function () {

        describe(&#039;#header&#039;, function () {

            it(&#039;returns a valid authorization header (sha1)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha1&#039;
                };

                var header = Browser.client.header(&#039;http://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039; }).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;bsvY3IfUllw6V5rvk4tStEvpBhE=&quot;, ext=&quot;Bazinga!&quot;, mac=&quot;qbf1ZPG/r/e06F4ht+T77LXi5vw=&quot;&#039;);
                done();
            });

            it(&#039;returns a valid authorization header (sha256)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; }).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=&quot;, ext=&quot;Bazinga!&quot;, mac=&quot;q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8=&quot;&#039;);
                done();
            });

            it(&#039;returns a valid authorization header (empty payload)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha1&#039;
                };

                var header = Browser.client.header(&#039;http://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;&#039; }).field;
                expect(header).to.equal(&#039;Hawk id=\&quot;123456\&quot;, ts=\&quot;1353809207\&quot;, nonce=\&quot;Ygvqdz\&quot;, hash=\&quot;404ghL7K+hfyhByKKejFBRGgTjU=\&quot;, ext=\&quot;Bazinga!\&quot;, mac=\&quot;Bh1sj1DOfFRWOdi3ww52nLCJdBE=\&quot;&#039;);
                done();
            });

            it(&#039;returns a valid authorization header (no ext)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; }).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=&quot;, mac=&quot;HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs=&quot;&#039;);
                done();
            });

            it(&#039;returns a valid authorization header (null ext)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039;, ext: null }).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=&quot;, mac=&quot;HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs=&quot;&#039;);
                done();
            });

            it(&#039;returns a valid authorization header (uri object)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var uri = Browser.utils.parseUri(&#039;https://example.net/somewhere/over/the/rainbow&#039;);
                var header = Browser.client.header(uri, &#039;POST&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; }).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=&quot;, mac=&quot;HTgtd0jPI6E4izx8e4OHdO36q00xFCU0FolNq3RiCYs=&quot;&#039;);
                done();
            });

            it(&#039;errors on missing options&#039;, function (done) {

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;);
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid argument type&#039;);
                done();
            });

            it(&#039;errors on empty uri&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;&#039;, &#039;POST&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid argument type&#039;);
                done();
            });

            it(&#039;errors on invalid uri&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(4, &#039;POST&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid argument type&#039;);
                done();
            });

            it(&#039;errors on missing method&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;&#039;, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid argument type&#039;);
                done();
            });

            it(&#039;errors on invalid method&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, 5, { credentials: credentials, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid argument type&#039;);
                done();
            });

            it(&#039;errors on missing credentials&#039;, function (done) {

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { ext: &#039;Bazinga!&#039;, timestamp: 1353809207 });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid credentials object&#039;);
                done();
            });

            it(&#039;errors on invalid credentials (id)&#039;, function (done) {

                var credentials = {
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207 });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid credentials object&#039;);
                done();
            });

            it(&#039;errors on invalid credentials (key)&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207 });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Invalid credentials object&#039;);
                done();
            });

            it(&#039;errors on invalid algorithm&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;hmac-sha-0&#039;
                };

                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, { credentials: credentials, payload: &#039;something, anything!&#039;, ext: &#039;Bazinga!&#039;, timestamp: 1353809207 });
                expect(header.field).to.equal(&#039;&#039;);
                expect(header.err).to.equal(&#039;Unknown algorithm&#039;);
                done();
            });

            it(&#039;uses a pre-calculated payload hash&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;2983d45yun89q&#039;,
                    algorithm: &#039;sha256&#039;
                };

                var options = { credentials: credentials, ext: &#039;Bazinga!&#039;, timestamp: 1353809207, nonce: &#039;Ygvqdz&#039;, payload: &#039;something to write about&#039;, contentType: &#039;text/plain&#039; };
                options.hash = Browser.crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);
                var header = Browser.client.header(&#039;https://example.net/somewhere/over/the/rainbow&#039;, &#039;POST&#039;, options).field;
                expect(header).to.equal(&#039;Hawk id=&quot;123456&quot;, ts=&quot;1353809207&quot;, nonce=&quot;Ygvqdz&quot;, hash=&quot;2QfCt3GuY9HQnHWyWD3wX68ZOKbynqlfYmuO2ZBRqtY=&quot;, ext=&quot;Bazinga!&quot;, mac=&quot;q1CwFoSHzPZSkbIvl0oYlD+91rBUEvFk763nMjMndj8=&quot;&#039;);
                done();
            });
        });

        describe(&#039;#authenticate&#039;, function () {

            it(&#039;skips tsm validation when missing ts&#039;, function (done) {

                var res = {
                    headers: {
                        &#039;www-authenticate&#039;: &#039;Hawk error=&quot;Stale timestamp&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#039;,
                    algorithm: &#039;sha256&#039;,
                    user: &#039;steve&#039;
                };

                var artifacts = {
                    ts: 1402135580,
                    nonce: &#039;iBRB6t&#039;,
                    method: &#039;GET&#039;,
                    resource: &#039;/resource/4?filter=a&#039;,
                    host: &#039;example.com&#039;,
                    port: &#039;8080&#039;,
                    ext: &#039;some-app-data&#039;
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(true);
                done();
            });

            it(&#039;returns false on invalid header&#039;, function (done) {

                var res = {
                    headers: {
                        &#039;server-authorization&#039;: &#039;Hawk mac=&quot;abc&quot;, bad=&quot;xyz&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, {})).to.equal(false);
                done();
            });

            it(&#039;returns false on invalid mac&#039;, function (done) {

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;,
                        &#039;server-authorization&#039;: &#039;Hawk mac=&quot;_IJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=&quot;, hash=&quot;f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=&quot;, ext=&quot;response-specific&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                var artifacts = {
                    method: &#039;POST&#039;,
                    host: &#039;example.com&#039;,
                    port: &#039;8080&#039;,
                    resource: &#039;/resource/4?filter=a&#039;,
                    ts: &#039;1362336900&#039;,
                    nonce: &#039;eb5S_L&#039;,
                    hash: &#039;nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=&#039;,
                    ext: &#039;some-app-data&#039;,
                    app: undefined,
                    dlg: undefined,
                    mac: &#039;BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=&#039;,
                    id: &#039;123456&#039;
                };

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#039;,
                    algorithm: &#039;sha256&#039;,
                    user: &#039;steve&#039;
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(false);
                done();
            });

            it(&#039;returns true on ignoring hash&#039;, function (done) {

                var res = {
                    headers: {
                        &#039;content-type&#039;: &#039;text/plain&#039;,
                        &#039;server-authorization&#039;: &#039;Hawk mac=&quot;XIJRsMl/4oL+nn+vKoeVZPdCHXB4yJkNnBbTbHFZUYE=&quot;, hash=&quot;f9cDF/TDm7TkYRLnGwRMfeDzT6LixQVLvrIKhh0vgmM=&quot;, ext=&quot;response-specific&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                var artifacts = {
                    method: &#039;POST&#039;,
                    host: &#039;example.com&#039;,
                    port: &#039;8080&#039;,
                    resource: &#039;/resource/4?filter=a&#039;,
                    ts: &#039;1362336900&#039;,
                    nonce: &#039;eb5S_L&#039;,
                    hash: &#039;nJjkVtBE5Y/Bk38Aiokwn0jiJxt/0S2WRSUwWLCf5xk=&#039;,
                    ext: &#039;some-app-data&#039;,
                    app: undefined,
                    dlg: undefined,
                    mac: &#039;BlmSe8K+pbKIb6YsZCnt4E1GrYvY1AaYayNR82dGpIk=&#039;,
                    id: &#039;123456&#039;
                };

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#039;,
                    algorithm: &#039;sha256&#039;,
                    user: &#039;steve&#039;
                };

                expect(Browser.client.authenticate(res, credentials, artifacts)).to.equal(true);
                done();
            });

            it(&#039;errors on invalid WWW-Authenticate header format&#039;, function (done) {

                var res = {
                    headers: {
                        &#039;www-authenticate&#039;: &#039;Hawk ts=&quot;1362346425875&quot;, tsm=&quot;PhwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=&quot;, x=&quot;Stale timestamp&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, {})).to.equal(false);
                done();
            });

            it(&#039;errors on invalid WWW-Authenticate header format&#039;, function (done) {

                var credentials = {
                    id: &#039;123456&#039;,
                    key: &#039;werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn&#039;,
                    algorithm: &#039;sha256&#039;,
                    user: &#039;steve&#039;
                };

                var res = {
                    headers: {
                        &#039;www-authenticate&#039;: &#039;Hawk ts=&quot;1362346425875&quot;, tsm=&quot;hwayS28vtnn3qbv0mqRBYSXebN/zggEtucfeZ620Zo=&quot;, error=&quot;Stale timestamp&quot;&#039;
                    },
                    getResponseHeader: function (header) {

                        return res.headers[header.toLowerCase()];
                    }
                };

                expect(Browser.client.authenticate(res, credentials)).to.equal(false);
                done();
            });
        });

        describe(&#039;#message&#039;, function () {

            it(&#039;generates an authorization then successfully parse it&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, { credentials: credentials });
                    expect(auth).to.exist;

                    Hawk.server.authenticateMessage(&#039;example.com&#039;, 8080, &#039;some message&#039;, auth, credentialsFunc, {}, function (err, credentials) {

                        expect(err).to.not.exist;
                        expect(credentials.user).to.equal(&#039;steve&#039;);
                        done();
                    });
                });
            });

            it(&#039;generates an authorization using custom nonce/timestamp&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, { credentials: credentials, nonce: &#039;abc123&#039;, timestamp: 1398536270957 });
                    expect(auth).to.exist;
                    expect(auth.nonce).to.equal(&#039;abc123&#039;);
                    expect(auth.ts).to.equal(1398536270957);
                    done();
                });
            });

            it(&#039;errors on missing host&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(null, 8080, &#039;some message&#039;, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on invalid host&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(5, 8080, &#039;some message&#039;, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on missing port&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 0, &#039;some message&#039;, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on invalid port&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, &#039;a&#039;, &#039;some message&#039;, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on missing message&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, undefined, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on null message&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, null, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on invalid message&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, 5, { credentials: credentials });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on missing credentials&#039;, function (done) {

                var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, {});
                expect(auth).to.not.exist;
                done();
            });

            it(&#039;errors on missing options&#039;, function (done) {

                var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;);
                expect(auth).to.not.exist;
                done();
            });

            it(&#039;errors on invalid credentials (id)&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var creds = Hoek.clone(credentials);
                    delete creds.id;
                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, { credentials: creds });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on invalid credentials (key)&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var creds = Hoek.clone(credentials);
                    delete creds.key;
                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, { credentials: creds });
                    expect(auth).to.not.exist;
                    done();
                });
            });

            it(&#039;errors on invalid algorithm&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var creds = Hoek.clone(credentials);
                    creds.algorithm = &#039;blah&#039;;
                    var auth = Browser.client.message(&#039;example.com&#039;, 8080, &#039;some message&#039;, { credentials: creds });
                    expect(auth).to.not.exist;
                    done();
                });
            });
        });

        describe(&#039;#authenticateTimestamp&#039;, function (done) {

            it(&#039;validates a timestamp&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var tsm = Hawk.crypto.timestampMessage(credentials);
                    expect(Browser.client.authenticateTimestamp(tsm, credentials)).to.equal(true);
                    done();
                });
            });

            it(&#039;validates a timestamp without updating local time&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var offset = Browser.utils.getNtpOffset();
                    var tsm = Hawk.crypto.timestampMessage(credentials, 10000);
                    expect(Browser.client.authenticateTimestamp(tsm, credentials, false)).to.equal(true);
                    expect(offset).to.equal(Browser.utils.getNtpOffset());
                    done();
                });
            });

            it(&#039;detects a bad timestamp&#039;, function (done) {

                credentialsFunc(&#039;123456&#039;, function (err, credentials) {

                    var tsm = Hawk.crypto.timestampMessage(credentials);
                    tsm.ts = 4;
                    expect(Browser.client.authenticateTimestamp(tsm, credentials)).to.equal(false);
                    done();
                });
            });
        });
    });

    describe(&#039;internals&#039;, function () {

        describe(&#039;LocalStorage&#039;, function () {

            it(&#039;goes through the full lifecycle&#039;, function (done) {

                var storage = new Browser.internals.LocalStorage();
                expect(storage.length).to.equal(0);
                expect(storage.getItem(&#039;a&#039;)).to.equal(null);
                storage.setItem(&#039;a&#039;, 5);
                expect(storage.length).to.equal(1);
                expect(storage.key()).to.equal(&#039;a&#039;);
                expect(storage.key(0)).to.equal(&#039;a&#039;);
                expect(storage.getItem(&#039;a&#039;)).to.equal(&#039;5&#039;);
                storage.setItem(&#039;b&#039;, &#039;test&#039;);
                expect(storage.key()).to.equal(&#039;a&#039;);
                expect(storage.key(0)).to.equal(&#039;a&#039;);
                expect(storage.key(1)).to.equal(&#039;b&#039;);
                expect(storage.length).to.equal(2);
                expect(storage.getItem(&#039;b&#039;)).to.equal(&#039;test&#039;);
                storage.removeItem(&#039;a&#039;);
                expect(storage.length).to.equal(1);
                expect(storage.getItem(&#039;a&#039;)).to.equal(null);
                expect(storage.getItem(&#039;b&#039;)).to.equal(&#039;test&#039;);
                storage.clear();
                expect(storage.length).to.equal(0);
                expect(storage.getItem(&#039;a&#039;)).to.equal(null);
                expect(storage.getItem(&#039;b&#039;)).to.equal(null);
                done();
            });
        });
    });

    describe(&#039;utils&#039;, function () {

        describe(&#039;#setStorage&#039;, function () {

            it(&#039;sets storage for the first time&#039;, function (done) {

                Browser.utils.storage = new Browser.internals.LocalStorage();        // Reset state

                expect(Browser.utils.storage.getItem(&#039;hawk_ntp_offset&#039;)).to.not.exist;
                Browser.utils.storage.setItem(&#039;test&#039;, &#039;1&#039;);
                Browser.utils.setStorage(new Browser.internals.LocalStorage());
                expect(Browser.utils.storage.getItem(&#039;test&#039;)).to.not.exist;
                Browser.utils.storage.setItem(&#039;test&#039;, &#039;2&#039;);
                expect(Browser.utils.storage.getItem(&#039;test&#039;)).to.equal(&#039;2&#039;);
                done();
            });
        });

        describe(&#039;#setNtpOffset&#039;, function (done) {

            it(&#039;catches localStorage errors&#039;, function (done) {

                var orig = Browser.utils.storage.setItem;
                var error = console.error;
                var count = 0;
                console.error = function () { if (count++ === 2) { console.error = error; } };
                Browser.utils.storage.setItem = function () {

                    Browser.utils.storage.setItem = orig;
                    throw new Error()
                };

                expect(function () {
                    Browser.utils.setNtpOffset(100);
                }).not.to.throw();

                done();
            });
        });

        describe(&#039;#parseAuthorizationHeader&#039;, function (done) {

            it(&#039;returns null on missing header&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader()).to.equal(null);
                done();
            });

            it(&#039;returns null on bad header syntax (structure)&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader(&#039;Hawk&#039;)).to.equal(null);
                done();
            });

            it(&#039;returns null on bad header syntax (parts)&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader(&#039; &#039;)).to.equal(null);
                done();
            });

            it(&#039;returns null on bad scheme name&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader(&#039;Basic asdasd&#039;)).to.equal(null);
                done();
            });

            it(&#039;returns null on bad attribute value&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader(&#039;Hawk test=&quot;\t&quot;&#039;, [&#039;test&#039;])).to.equal(null);
                done();
            });

            it(&#039;returns null on duplicated attribute&#039;, function (done) {

                expect(Browser.utils.parseAuthorizationHeader(&#039;Hawk test=&quot;a&quot;, test=&quot;b&quot;&#039;, [&#039;test&#039;])).to.equal(null);
                done();
            });
        });

        describe(&#039;#parseUri&#039;, function () {

            it(&#039;returns empty port when unknown scheme&#039;, function (done) {

                var uri = Browser.utils.parseUri(&#039;ftp://domain&#039;);
                expect(uri.port).to.equal(&#039;&#039;);
                done();
            });

            it(&#039;returns default port when missing&#039;, function (done) {

                var uri = Browser.utils.parseUri(&#039;http://&#039;);
                expect(uri.port).to.equal(&#039;80&#039;);
                done();
            });
        });

        var str = &quot;https://www.google.ca/webhp?sourceid=chrome-instant&amp;ion=1&amp;espv=2&amp;ie=UTF-8#q=url&quot;;
        var base64str = &quot;aHR0cHM6Ly93d3cuZ29vZ2xlLmNhL3dlYmhwP3NvdXJjZWlkPWNocm9tZS1pbnN0YW50Jmlvbj0xJmVzcHY9MiZpZT1VVEYtOCNxPXVybA&quot;;

        describe(&#039;#base64urlEncode&#039;, function () {

            it(&#039;should base64 URL-safe decode a string&#039;, function (done) {

                expect(Browser.utils.base64urlEncode(str)).to.equal(base64str);
                done();
            });

        });

    });
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
