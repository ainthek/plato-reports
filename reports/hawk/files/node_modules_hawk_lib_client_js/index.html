<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - node_modules/hawk/lib/client.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>node_modules/hawk/lib/client.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">48.06</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">364</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">48.15</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.28</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">// Load modules

var Url = require(&#039;url&#039;);
var Hoek = require(&#039;hoek&#039;);
var Cryptiles = require(&#039;cryptiles&#039;);
var Crypto = require(&#039;./crypto&#039;);
var Utils = require(&#039;./utils&#039;);


// Declare internals

var internals = {};


// Generate an Authorization header for a given request

/*
    uri: &#039;http://example.com/resource?a=b&#039; or object from Url.parse()
    method: HTTP verb (e.g. &#039;GET&#039;, &#039;POST&#039;)
    options: {

        // Required

        credentials: {
            id: &#039;dh37fgj492je&#039;,
            key: &#039;aoijedoaijsdlaksjdl&#039;,
            algorithm: &#039;sha256&#039;                                 // &#039;sha1&#039;, &#039;sha256&#039;
        },

        // Optional

        ext: &#039;application-specific&#039;,                        // Application specific data sent via the ext attribute
        timestamp: Date.now(),                              // A pre-calculated timestamp
        nonce: &#039;2334f34f&#039;,                                  // A pre-generated nonce
        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)
        payload: &#039;{&quot;some&quot;:&quot;payload&quot;}&#039;,                      // UTF-8 encoded string for body hash generation (ignored if hash provided)
        contentType: &#039;application/json&#039;,                    // Payload content-type (ignored if hash provided)
        hash: &#039;U4MKKSmiVxk37JCCrAVIjV=&#039;,                    // Pre-calculated payload hash
        app: &#039;24s23423f34dx&#039;,                               // Oz application id
        dlg: &#039;234sz34tww3sd&#039;                                // Oz delegated-by application id
    }
*/

exports.header = function (uri, method, options) {

    var result = {
        field: &#039;&#039;,
        artifacts: {}
    };

    // Validate inputs

    if (!uri || (typeof uri !== &#039;string&#039; &amp;&amp; typeof uri !== &#039;object&#039;) ||
        !method || typeof method !== &#039;string&#039; ||
        !options || typeof options !== &#039;object&#039;) {

        result.err = &#039;Invalid argument type&#039;;
        return result;
    }

    // Application time

    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);

    // Validate credentials

    var credentials = options.credentials;
    if (!credentials ||
        !credentials.id ||
        !credentials.key ||
        !credentials.algorithm) {

        result.err = &#039;Invalid credential object&#039;;
        return result;
    }

    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {
        result.err = &#039;Unknown algorithm&#039;;
        return result;
    }

    // Parse URI

    if (typeof uri === &#039;string&#039;) {
        uri = Url.parse(uri);
    }

    // Calculate signature

    var artifacts = {
        ts: timestamp,
        nonce: options.nonce || Cryptiles.randomString(6),
        method: method,
        resource: uri.pathname + (uri.search || &#039;&#039;),                            // Maintain trailing &#039;?&#039;
        host: uri.hostname,
        port: uri.port || (uri.protocol === &#039;http:&#039; ? 80 : 443),
        hash: options.hash,
        ext: options.ext,
        app: options.app,
        dlg: options.dlg
    };

    result.artifacts = artifacts;

    // Calculate payload hash

    if (!artifacts.hash &amp;&amp;
        (options.payload || options.payload === &#039;&#039;)) {

        artifacts.hash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, options.contentType);
    }

    var mac = Crypto.calculateMac(&#039;header&#039;, credentials, artifacts);

    // Construct header

    var hasExt = artifacts.ext !== null &amp;&amp; artifacts.ext !== undefined &amp;&amp; artifacts.ext !== &#039;&#039;;       // Other falsey values allowed
    var header = &#039;Hawk id=&quot;&#039; + credentials.id +
                 &#039;&quot;, ts=&quot;&#039; + artifacts.ts +
                 &#039;&quot;, nonce=&quot;&#039; + artifacts.nonce +
                 (artifacts.hash ? &#039;&quot;, hash=&quot;&#039; + artifacts.hash : &#039;&#039;) +
                 (hasExt ? &#039;&quot;, ext=&quot;&#039; + Hoek.escapeHeaderAttribute(artifacts.ext) : &#039;&#039;) +
                 &#039;&quot;, mac=&quot;&#039; + mac + &#039;&quot;&#039;;

    if (artifacts.app) {
        header += &#039;, app=&quot;&#039; + artifacts.app +
                  (artifacts.dlg ? &#039;&quot;, dlg=&quot;&#039; + artifacts.dlg : &#039;&#039;) + &#039;&quot;&#039;;
    }

    result.field = header;

    return result;
};


// Validate server response

/*
    res:        node&#039;s response object
    artifacts:  object received from header().artifacts
    options: {
        payload:    optional payload received
        required:   specifies if a Server-Authorization header is required. Defaults to &#039;false&#039;
    }
*/

exports.authenticate = function (res, credentials, artifacts, options) {

    artifacts = Hoek.clone(artifacts);
    options = options || {};

    if (res.headers[&#039;www-authenticate&#039;]) {

        // Parse HTTP WWW-Authenticate header

        var attributes = Utils.parseAuthorizationHeader(res.headers[&#039;www-authenticate&#039;], [&#039;ts&#039;, &#039;tsm&#039;, &#039;error&#039;]);
        if (attributes instanceof Error) {
            return false;
        }

        // Validate server timestamp (not used to update clock since it is done via the SNPT client)

        if (attributes.ts) {
            var tsm = Crypto.calculateTsMac(attributes.ts, credentials);
            if (tsm !== attributes.tsm) {
                return false;
            }
        }
    }

    // Parse HTTP Server-Authorization header

    if (!res.headers[&#039;server-authorization&#039;] &amp;&amp;
        !options.required) {

        return true;
    }

    var attributes = Utils.parseAuthorizationHeader(res.headers[&#039;server-authorization&#039;], [&#039;mac&#039;, &#039;ext&#039;, &#039;hash&#039;]);
    if (attributes instanceof Error) {
        return false;
    }

    artifacts.ext = attributes.ext;
    artifacts.hash = attributes.hash;

    var mac = Crypto.calculateMac(&#039;response&#039;, credentials, artifacts);
    if (mac !== attributes.mac) {
        return false;
    }

    if (!options.payload &amp;&amp;
        options.payload !== &#039;&#039;) {

        return true;
    }

    if (!attributes.hash) {
        return false;
    }

    var calculatedHash = Crypto.calculatePayloadHash(options.payload, credentials.algorithm, res.headers[&#039;content-type&#039;]);
    return (calculatedHash === attributes.hash);
};


// Generate a bewit value for a given URI

/*
    uri: &#039;http://example.com/resource?a=b&#039; or object from Url.parse()
    options: {

        // Required

        credentials: {
            id: &#039;dh37fgj492je&#039;,
            key: &#039;aoijedoaijsdlaksjdl&#039;,
            algorithm: &#039;sha256&#039;                             // &#039;sha1&#039;, &#039;sha256&#039;
        },
        ttlSec: 60 * 60,                                    // TTL in seconds

        // Optional

        ext: &#039;application-specific&#039;,                        // Application specific data sent via the ext attribute
        localtimeOffsetMsec: 400                            // Time offset to sync with server time
    };
*/

exports.getBewit = function (uri, options) {

    // Validate inputs

    if (!uri ||
        (typeof uri !== &#039;string&#039; &amp;&amp; typeof uri !== &#039;object&#039;) ||
        !options ||
        typeof options !== &#039;object&#039; ||
        !options.ttlSec) {

        return &#039;&#039;;
    }

    options.ext = (options.ext === null || options.ext === undefined ? &#039;&#039; : options.ext);       // Zero is valid value

    // Application time

    var now = Utils.now(options.localtimeOffsetMsec);

    // Validate credentials

    var credentials = options.credentials;
    if (!credentials ||
        !credentials.id ||
        !credentials.key ||
        !credentials.algorithm) {

        return &#039;&#039;;
    }

    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {
        return &#039;&#039;;
    }

    // Parse URI

    if (typeof uri === &#039;string&#039;) {
        uri = Url.parse(uri);
    }

    // Calculate signature

    var exp = Math.floor(now / 1000) + options.ttlSec;
    var mac = Crypto.calculateMac(&#039;bewit&#039;, credentials, {
        ts: exp,
        nonce: &#039;&#039;,
        method: &#039;GET&#039;,
        resource: uri.pathname + (uri.search || &#039;&#039;),                            // Maintain trailing &#039;?&#039;
        host: uri.hostname,
        port: uri.port || (uri.protocol === &#039;http:&#039; ? 80 : 443),
        ext: options.ext
    });

    // Construct bewit: id\exp\mac\ext

    var bewit = credentials.id + &#039;\\&#039; + exp + &#039;\\&#039; + mac + &#039;\\&#039; + options.ext;
    return Hoek.base64urlEncode(bewit);
};


// Generate an authorization string for a message

/*
    host: &#039;example.com&#039;,
    port: 8000,
    message: &#039;{&quot;some&quot;:&quot;payload&quot;}&#039;,                          // UTF-8 encoded string for body hash generation
    options: {

        // Required

        credentials: {
            id: &#039;dh37fgj492je&#039;,
            key: &#039;aoijedoaijsdlaksjdl&#039;,
            algorithm: &#039;sha256&#039;                             // &#039;sha1&#039;, &#039;sha256&#039;
        },

        // Optional

        timestamp: Date.now(),                              // A pre-calculated timestamp
        nonce: &#039;2334f34f&#039;,                                  // A pre-generated nonce
        localtimeOffsetMsec: 400,                           // Time offset to sync with server time (ignored if timestamp provided)
    }
*/

exports.message = function (host, port, message, options) {

    // Validate inputs

    if (!host || typeof host !== &#039;string&#039; ||
        !port || typeof port !== &#039;number&#039; ||
        message === null || message === undefined || typeof message !== &#039;string&#039; ||
        !options || typeof options !== &#039;object&#039;) {

        return null;
    }

    // Application time

    var timestamp = options.timestamp || Utils.nowSecs(options.localtimeOffsetMsec);

    // Validate credentials

    var credentials = options.credentials;
    if (!credentials ||
        !credentials.id ||
        !credentials.key ||
        !credentials.algorithm) {

        // Invalid credential object
        return null;
    }

    if (Crypto.algorithms.indexOf(credentials.algorithm) === -1) {
        return null;
    }

    // Calculate signature

    var artifacts = {
        ts: timestamp,
        nonce: options.nonce || Cryptiles.randomString(6),
        host: host,
        port: port,
        hash: Crypto.calculatePayloadHash(message, credentials.algorithm)
    };

    // Construct authorization

    var result = {
        id: credentials.id,
        ts: artifacts.ts,
        nonce: artifacts.nonce,
        hash: artifacts.hash,
        mac: Crypto.calculateMac(&#039;message&#039;, credentials, artifacts)
    };

    return result;
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
